[Status:Draft]()
# Use of OpenTimelineIO for arbitrary time-series data

- Copyright: Signly Ltd & Michael Davey Consulting Ltd, version 0.1
- License: [Apache 2.0](/proposals/usdotio/LICENSE.md)

## Use Case
- **In order to** quickly interpret and gain insights into the results and find the specific scene(s), object(s), time(s), ... I am interested in,
- **As a** creative,
- **I want to** run task-oriented analysis tools on my OpenUSD project and see the results represented on a timeline as time-series data
- **Whereas currently** I would need to either,
    - Where possible, build a custom extension with its own timeline widget, or
    - Where possible, customise the standard DCC or NLE sequencer timeline widget to fetch the results from the analysis tool, or
    - Use an external analyser application with its own timeline widget

## Example DCC/NLE Workflow

1. A creative working in a DCC or NLE has loaded up a project with at least one timeline defined.
    - They select the timeline then pick an analysis tool to run on the timeline.
2. The analysis tool produces its output (arbitrary time-series data) in OpenTimelineIO format.
    - The track *kind* is set to a tool-specific name (labeled with a tool-specific schema).
    - The OTIO data in inserted into OpenUSD (OpenUSD OTIO schema)
3. The DCCs or NLEs standard sequencer timeline UI component can render the time-series data on the timeline without requiring the analyser tool to be present and without needing to know about the semantic meaning of what it is displaying.
    - If the appropriate analysis tool is present, additional functionality (such as context-sensitive menu options) may be enabled in the Sequencer 
    - The sequencer or extension manager may be able to automatically find and install / enable the extensions indicated by the track kind if the tool is not present or not enabled by default.

<div style="text-align: center;">

![Alt](/proposals/usdotio/Analysis%20menu.png)

</div>

In a DCC or NLE, analysis tools lend themselves to implementation using a plugin architecture, as this empowers creative professionals to pick the best tools for their specific workflow from a rich ecosystem.
- In Omniverse terminology for instance, an analysis tool would be an Omniverse extension.
- The tool may very well call a microservices API such as an Omniverse microservice or an NVIDIA Inference Microservice (NIM).


![Alt](/proposals/usdotio/Workflow.png)


## OpenUSD serialisation
This proposal creates an OpenUSD serialisation of the OpenTimelineIO schema, to complement the existing JSON serialisation.  The intention is that transliteration between OpenUSD and JSON serialisations of the OpenTimelineIO schema is lossless.

To achieve this serialisation in OpenUSD using OpenUSD's atomic types, we create a new OpenUSD codeless schema to hold the OpenTimelineIO data.

### OpenUSD OTIO serialization (proposed)
OpenTimelineIO serialization in OpenUSD looks like this (proposed):

<details>

```c++ (actually OpenUSD)
#usda 1.0
(
    "WARNING: THIS FILE IS GENERATED BY usdGenSchema.  DO NOT EDIT."
)


class OtioBase "OtioBase" (
    doc = "Defines an abstract OpenTimelineIO primitive root schema."
)
{
    uniform string OTIO_SCHEMA = "" (
        doc = "JSON schema"
    )
    uniform string unknown = "" (
        doc = "Unknown JSON data."
    )
}


class OtioNamedBase "OtioNamedBase" (
    doc = "Defines an abstract OpenTimelineIO primitive root schema."
)
{
    uniform string metadata = "" (
        doc = "User defined metadata."
    )
    uniform string name = "" (
        doc = "User defined name."
    )
    uniform string OTIO_SCHEMA = "" (
        doc = "JSON schema"
    )
    uniform string unknown = "" (
        doc = "Unknown JSON data."
    )
}


class OtioRationalTime "OtioRationalTime" (
    doc = "Defines a concrete OpenTimelineIO rational time schema."
)
{
    uniform string OTIO_SCHEMA = "" (
        doc = "JSON schema"
    )
    double rate = 24 (
        doc = "Denominator of rational time"
    )
    uniform string unknown = "" (
        doc = "Unknown JSON data."
    )
    double value = 0 (
        doc = "Numerator of rational time"
    )
}


class OtioTimeRange "OtioTimeRange" (
    doc = "Defines a concrete OpenTimelineIO time range schema."
)
{
    uniform string OTIO_SCHEMA = "" (
        doc = "JSON schema"
    )
    uniform string unknown = "" (
        doc = "Unknown JSON data."
    )
}


class OtioTimeline "OtioTimeline" (
    doc = "Defines a concrete OpenTimelineIO timeline schema."
)
{
    uniform string metadata = "" (
        doc = "User defined metadata."
    )
    uniform string name = "" (
        doc = "User defined name."
    )
    uniform string OTIO_SCHEMA = "" (
        doc = "JSON schema"
    )
    uniform string unknown = "" (
        doc = "Unknown JSON data."
    )
}


class OtioStack "OtioStack" (
    doc = "Defines a concrete OpenTimelineIO stack schema."
)
{
    bool enabled = 1 (
        doc = "Allows you to disable this stack"
    )
    uniform string metadata = "" (
        doc = "User defined metadata."
    )
    uniform string name = "" (
        doc = "User defined name."
    )
    uniform string OTIO_SCHEMA = "" (
        doc = "JSON schema"
    )
    uniform string unknown = "" (
        doc = "Unknown JSON data."
    )
}


class OtioTrack "OtioTrack" (
    doc = "Defines a concrete OpenTimelineIO track schema."
)
{
    bool enabled = 1 (
        doc = "Allows you to disable this track"
    )
    uniform string kind = "" (
        doc = "Type of track"
    )
    uniform string metadata = "" (
        doc = "User defined metadata."
    )
    uniform string name = "" (
        doc = "User defined name."
    )
    uniform string OTIO_SCHEMA = "" (
        doc = "JSON schema"
    )
    uniform string unknown = "" (
        doc = "Unknown JSON data."
    )
}


class OtioClip "OtioClip" (
    doc = "Defines a concrete OpenTimelineIO clip schema."
)
{
    uniform string active_media_reference_key (
        doc = ""
    )
    bool enabled = 1 (
        doc = "Allows you to disable this clip"
    )
    uniform string metadata = "" (
        doc = "User defined metadata."
    )
    uniform string name = "" (
        doc = "User defined name."
    )
    uniform string OTIO_SCHEMA = "" (
        doc = "JSON schema"
    )
    uniform string unknown = "" (
        doc = "Unknown JSON data."
    )
}


class OtioGap "OtioGap" (
    doc = "Defines a concrete OpenTimelineIO clip schema."
)
{
    bool enabled = 1 (
        doc = "Allows you to disable this gap"
    )
    uniform string metadata = "" (
        doc = "User defined metadata."
    )
    uniform string name = "" (
        doc = "User defined name."
    )
    uniform string OTIO_SCHEMA = "" (
        doc = "JSON schema"
    )
    uniform string unknown = "" (
        doc = "Unknown JSON data."
    )
}


class OtioTransition "OtioTransition" (
    doc = "Defines a concrete OpenTimelineIO transition schema."
)
{
    uniform string metadata = "" (
        doc = "User defined metadata."
    )
    uniform string name = "" (
        doc = "User defined name."
    )
    uniform string OTIO_SCHEMA = "" (
        doc = "JSON schema"
    )
    uniform string transition_type = ""
    uniform string unknown = "" (
        doc = "Unknown JSON data."
    )
}


class OtioEffect "OtioEffect" (
    doc = "Defines a concrete OpenTimelineIO effect schema."
)
{
    uniform string effect_name = "" (
        doc = "Name of the effect"
    )
    uniform string metadata = "" (
        doc = "User defined metadata."
    )
    uniform string name = "" (
        doc = "User defined name."
    )
    uniform string OTIO_SCHEMA = "" (
        doc = "JSON schema"
    )
    uniform string unknown = "" (
        doc = "Unknown JSON data."
    )
}


class OtioLinearTimeWarp "OtioLinearTimeWarp" (
    doc = "Defines a concrete OpenTimelineIO linear time warp schema."
)
{
    uniform string effect_name = "" (
        doc = "Name of the effect"
    )
    uniform string metadata = "" (
        doc = "User defined metadata."
    )
    uniform string name = "" (
        doc = "User defined name."
    )
    uniform string OTIO_SCHEMA = "" (
        doc = "JSON schema"
    )
    double time_scalar = 1 (
        doc = "Scale the item by this amount."
    )
    uniform string unknown = "" (
        doc = "Unknown JSON data."
    )
}


class OtioMissingReference "OtioMissingReference" (
    doc = "Defines a concrete OpenTimelineIO media reference schema."
)
{
    uniform string metadata = "" (
        doc = "User defined metadata."
    )
    uniform string name = "" (
        doc = "User defined name."
    )
    uniform string OTIO_SCHEMA = "" (
        doc = "JSON schema"
    )
    uniform string unknown = "" (
        doc = "Unknown JSON data."
    )
}


class OtioExternalReference "OtioExternalReference" (
    doc = "Defines a concrete OpenTimelineIO external reference schema."
)
{
    uniform string metadata = "" (
        doc = "User defined metadata."
    )
    uniform string name = "" (
        doc = "User defined name."
    )
    uniform string OTIO_SCHEMA = "" (
        doc = "JSON schema"
    )
    uniform string target_url = "" (
        doc = "Url for the media"
    )
    uniform string unknown = "" (
        doc = "Unknown JSON data."
    )
}


class OtioImageSequenceReference "OtioImageSequenceReference" (
    doc = "Defines a concrete OpenTimelineIO external reference schema."
)
{
    uniform int frame_step = 1 (
        doc = "Stepping"
    )
    uniform int frame_zero_padding = 4 (
        doc = "Number of padded zeros"
    )
    uniform string metadata = "" (
        doc = "User defined metadata."
    )
    uniform string missing_frame_policy = "black" (
        doc = ""
    )
    uniform string name = "" (
        doc = "User defined name."
    )
    uniform string name_prefix = "" (
        doc = "Base name"
    )
    uniform string name_suffix = "" (
        doc = "Extension like .exr"
    )
    uniform string OTIO_SCHEMA = "" (
        doc = "JSON schema"
    )
    uniform double rate = 24 (
        doc = "Speed"
    )
    uniform int start_frame = 1 (
        doc = "First frame of sequence"
    )
    uniform string target_url_base = "" (
        doc = "URL or Directory"
    )
    uniform string unknown = "" (
        doc = "Unknown JSON data."
    )
}


class OtioMarker "OtioMarker" (
    doc = "Defines a concrete OpenTimelineIO marker schema."
)
{
    uniform string color = "green" (
        doc = "Color of the marker"
    )
    uniform string metadata = "" (
        doc = "User defined metadata."
    )
    uniform string name = "" (
        doc = "User defined name."
    )
    uniform string OTIO_SCHEMA = "" (
        doc = "JSON schema"
    )
    uniform string unknown = "" (
        doc = "Unknown JSON data."
    )
}


class OtioV2d "OtioV2d" (
    doc = "Defines a concrete OpenTimelineIO 2D vector schema."
)
{
    float x (
        doc = "x of vector"
    )
    float y (
        doc = "y of vector"
    )
}


class OtioBox2d "OtioBox2d" (
    doc = "Defines a concrete OpenTimelineIO box schema."
)
{
}
```
</details>

### Example
An example OpenUSD file using the above schema:

<details>

```c++ (actually OpenUSD)
#usda 1.0


def Xform "hello"
{
    def Sphere "world"
    {
    }
}


def OtioTimeline "otio"
{
    uniform string metadata = "{}"
    uniform string name = "SingleClip"
    uniform string OTIO_SCHEMA = "Timeline.1"


    def OtioStack "Stack"
    {
        bool enabled = 1
        uniform string metadata = "{}"
        uniform string name = "Stack"
        uniform string OTIO_SCHEMA = "Stack.1"


        def OtioTrack "Video_1"
        {
            bool enabled = 1
            uniform string kind = "Video"
            uniform string metadata = "{}"
            uniform string name = "Video"
            uniform string OTIO_SCHEMA = "Track.1"


            def OtioClip "Clip_1"
            {
                uniform string active_media_reference_key = "DEFAULT_MEDIA"
                bool enabled = 1
                uniform string metadata = "{}"
                uniform string name = "BART_2021-02-07"
                uniform string OTIO_SCHEMA = "Clip.2"


                def OtioTimeRange "source_range"
                {
                    uniform string OTIO_SCHEMA = "TimeRange.1"


                    def OtioRationalTime "start_time"
                    {
                        uniform string OTIO_SCHEMA = "RationalTime.1"
                        double rate = 30
                        double value = 90
                    }


                    def OtioRationalTime "duration"
                    {
                        uniform string OTIO_SCHEMA = "RationalTime.1"
                        double rate = 30
                        double value = 90
                    }
                }


                def OtioExternalReference "external_reference"
                {
                    uniform string metadata = "{}"
                    uniform string name = ""
                    uniform string OTIO_SCHEMA = "ExternalReference.1"
                    uniform string target_url = "BART_2021-02-07.m4v"


                    def OtioTimeRange "available_range"
                    {
                        uniform string OTIO_SCHEMA = "TimeRange.1"


                        def OtioRationalTime "start_time"
                        {
                            uniform string OTIO_SCHEMA = "RationalTime.1"
                            double rate = 30
                            double value = 0
                        }


                        def OtioRationalTime "duration"
                        {
                            uniform string OTIO_SCHEMA = "RationalTime.1"
                            double rate = 30
                            double value = 704
                        }
                    }
                }
            }
        }
    }
}
```
</details>

## Example timelines
### Object Analysis
Here is a mock-up of a timeline after an 'Object Analysis' tool has been run on the video elements of the timeline. The time-series data represents in which frames particular objects are present.
- This could potentially enable search functionality that would be able to respond to queries such as, "Show me all the scenes containing a woman wearing a wedding dress"

![Alt](/proposals/usdotio/Object%20Analysis.png)

### Speaker and Scene Analysis
Here is a mock-up of a timeline after both a 'Speaker Analysis' tool and a 'Scene Change Analysis' tool have been run on the the timeline. The time-series data represents in which frames particular characters are speaking, and where each scene change occurs.

![Alt](/proposals/usdotio/Speaker%20and%20Scene%20Analysis.png)

## Command line (proposed)
1. Embed the OpenTimelineIO metadata from json.otio into a OpenUSD file:
    - `usdotio add json.otio usdfile.usd`
2. Save the OpenTimelineIO metadata written by #1 to a JSON file:
    - `usdotio save -o json.otio usdfile.usd`
3. Find the Omniverse sequencer information, remove, convert to
OpenTimelineIO format and add back in again as OTIO metadata
    - `usdotio update usdfile.usd`

## Strawman implementation (PR #2995)
We've produced a proposed implementation the usdotio 'add' and 'save' commands (and an initial implementation of an OpenUSD codeless schema for OTIO), to spark discussion.
The codeless schema prepends the "Otio*" prefix to all its schemas and it is a direct 1:1 mapping of an OpenTimelineIO file. 

*"Adds a python script to add OpenTimelineIo data to and from a .usd file. The .otio information is stored in a tree fashion for easy inspecting it with usdview or similar.
You can have multiple .otio timelines, so that, for example, a TV set model carries its own .otio timeline differently from the main .otio at the root."*

- [**Created usdotio python script to add or extract .otio data from USD** *#2995*](https://github.com/PixarAnimationStudios/OpenUSD/pull/2995)

## Follow-on work
If this work is favourably recieved by the various stakeholder communities, we plan to create a new version of Omniverse's Sequencer extension that can read from and write to the OpenTimelineIO metadata section of OpenUSD described above in close collaboration with the Omniverse community, to further demonstrate the utility of this proposal.

## FAQs
An ongoing discussion within the OTIO community is how best to handle both dense time-sampled data and sparse time-sampled data. This proposal is silent on the subject: the same challenges (and potential solutions) that apply to OTIO data represented in JSON, also apply to that same OTIO data when represented in OpenUSD format. See [*Dense vs Sparse Time-Sampled Data*](https://docs.google.com/document/d/1pjWVgwJjt6N6V868geHNKBnqlZ_ACZCsEfZIaQRe-18/edit#heading=h.4yoitppk0adj) for further discussion on this subject.

## Supporting documentation
- [PDF presentation](/proposals/usdotio/OpenTimelineIO%20&%20OpenUSD.pdf)
- [OTIO + OpenUSD discussion / PoC document on ASWF.:OTIO](https://docs.google.com/document/d/1pjWVgwJjt6N6V868geHNKBnqlZ_ACZCsEfZIaQRe-18)
 
